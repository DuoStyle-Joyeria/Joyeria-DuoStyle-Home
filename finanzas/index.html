<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finanzas ‚Äî Joyer√≠a (MVP)</title>

  <!-- Tailwind para estilos -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js para gr√°ficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* peque√±os ajustes est√©ticos */
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
    .hidden { display: none !important; }
  </style>
  <!-- NOTA: NO incluir firebaseConfig aqu√≠ para evitar redeclare -->
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="app" class="max-w-6xl mx-auto p-4">
    <!-- AUTH -->
    <div id="authView" class="mt-10">
      <h1 class="text-2xl font-bold mb-4">Acceso</h1>
      <div class="grid md:grid-cols-2 gap-6">
        <form id="loginForm" class="bg-white p-4 rounded shadow space-y-3">
          <h2 class="font-semibold">Iniciar sesi√≥n</h2>
          <input id="loginEmail" type="email" required placeholder="Email" class="w-full border rounded p-2">
          <input id="loginPass" type="password" required placeholder="Contrase√±a" class="w-full border rounded p-2">
          <button class="w-full bg-slate-900 text-white py-2 rounded">Entrar</button>
        </form>

        <form id="registerForm" class="bg-white p-4 rounded shadow space-y-3">
          <h2 class="font-semibold">Crear cuenta</h2>
          <input id="regName" type="text" required placeholder="Tu nombre (p.ej. Brandon)" class="w-full border rounded p-2">
          <input id="regEmail" type="email" required placeholder="Email" class="w-full border rounded p-2">
          <input id="regPass" type="password" required placeholder="Contrase√±a" class="w-full border rounded p-2">
          <!-- No pedimos % de ahorro en registro -->
          <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear</button>
        </form>
      </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="mainView" class="hidden">
      <div class="flex items-center justify-between mt-4">
        <div>
          <h1 class="text-2xl font-bold">Panel ‚Äî Joyer√≠a</h1>
          <p id="companyName" class="text-sm text-slate-600"></p>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnSelectCompany" class="px-3 py-2 rounded border">Empresa</button>
          <button id="btnPerfil" class="px-3 py-2 rounded border">Perfil</button>
          <button id="btnLogout" class="px-3 py-2 rounded bg-slate-900 text-white">Salir</button>
        </div>
      </div>

      <!-- KPIs -->
      <div class="grid md:grid-cols-4 gap-4 mt-4">
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Empresa</div>
          <div id="kpiCajaEmpresa" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Brandon</div>
          <div id="kpiCajaBrandon" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Caja Socia</div>
          <div id="kpiCajaSocia" class="text-2xl font-semibold">$0</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <div class="text-sm text-slate-500">Deudas Totales</div>
          <div id="kpiDeudas" class="text-2xl font-semibold">$0</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="mt-6">
        <div class="flex gap-2 flex-wrap">
          <button data-tab="ventas" class="tab-btn px-3 py-2 rounded bg-slate-900 text-white">Ventas</button>
          <button data-tab="gastos" class="tab-btn px-3 py-2 rounded border">Gastos</button>
          <button data-tab="deudas" class="tab-btn px-3 py-2 rounded border">Deudas</button>
          <button data-tab="metas" class="tab-btn px-3 py-2 rounded border">Metas</button>
          <button data-tab="movimientos" class="tab-btn px-3 py-2 rounded border">Movimientos</button>
          <button data-tab="estadisticas" class="tab-btn px-3 py-2 rounded border">Estad√≠sticas</button>
        </div>

                <!-- VENTAS -->
        <section id="tab-ventas" class="tab mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formVenta" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Registrar Venta</h3>
              <input type="date" id="ventaFecha" required class="w-full border rounded p-2">
              <input type="text" id="ventaProducto" placeholder="Producto" required class="w-full border rounded p-2">
              <input type="number" id="ventaCosto" placeholder="Costo del producto" step="0.01" min="0" required class="w-full border rounded p-2">
              <input type="number" id="ventaPrecio" placeholder="Precio de venta" step="0.01" min="0" required class="w-full border rounded p-2">
              <textarea id="ventaNotas" placeholder="Notas" class="w-full border rounded p-2"></textarea>

              <div class="bg-slate-50 rounded p-3">
                <div class="text-sm font-medium">Origen de la inversi√≥n</div>
                <select id="ventaFinanciadaPor" class="w-full border rounded p-2 mt-2">
                  <option value="empresa">Empresa</option>
                  <option value="brandon">Brandon</option>
                  <option value="socia">Socia</option>
                </select>

                <label class="flex items-center gap-2 text-sm mt-3">
                  <input id="ventaManualToggle" type="checkbox" class="w-4 h-4">
                  <span>Usar distribuci√≥n manual (activar para decidir reinversi√≥n / pagos manualmente)</span>
                </label>

                <div id="manualDistribFields" class="mt-3 hidden">
                  <div class="text-sm font-medium">Distribuci√≥n manual</div>
                  <div class="grid grid-cols-2 gap-2 mt-2">
                    <input type="number" id="asigReinv" placeholder="Reinversi√≥n" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigBrandon" placeholder="Brandon" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigSocia" placeholder="Socia" step="0.01" min="0" class="border rounded p-2">
                    <input type="number" id="asigPagoDeuda" placeholder="Pago deuda" step="0.01" min="0" class="border rounded p-2">
                  </div>
                </div>

                <div id="autoDistribNote" class="mt-3 text-sm text-slate-600">
                  Modo autom√°tico: se devuelve la inversi√≥n al inversor (si financi√≥ la empresa se divide 50/50 si la empresa no tiene fondos). La utilidad se reparte 50/50 entre Brandon y la Socia.
                </div>
                <p id="ventaResumen" class="text-sm text-slate-600 mt-2"></p>
                <p id="sugerenciaAhorro" class="text-xs text-slate-600 mt-1"></p>
              </div>

              <input type="hidden" id="editingSaleId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Venta</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Ventas</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Producto</th><th>Precio</th><th>Costo</th><th>Utilidad</th><th>Margen</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbVentas"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- GASTOS -->
        <section id="tab-gastos" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formGasto" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Registrar Gasto</h3>
              <input type="date" id="gastoFecha" required class="w-full border rounded p-2">
              <input type="text" id="gastoCat" placeholder="Categor√≠a" required class="w-full border rounded p-2">
              <input type="number" id="gastoMonto" placeholder="Monto" step="0.01" min="0" required class="w-full border rounded p-2">
              <input type="text" id="gastoDesc" placeholder="Descripci√≥n" class="w-full border rounded p-2">
              <select id="gastoPagadoPor" class="w-full border rounded p-2">
                <option value="empresa">Empresa</option>
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
              </select>
              <input type="hidden" id="editingGastoId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Gasto</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Gastos</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Categor√≠a</th><th>Monto</th><th>Pagado por</th><th>Descripci√≥n</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbGastos"></tbody>
              </table>
            </div>
          </div>
        </section>



        <!-- =========================
     SECCI√ìN: DEUDAS (COMPLETA)
========================= -->
<section id="tab-deudas" class="tab hidden mt-4">
  <div class="grid md:grid-cols-2 gap-4">
    <!-- Formulario Crear/Editar Deuda -->
    <form id="formDeuda" class="bg-white p-4 rounded shadow space-y-2">
      <h3 class="font-semibold text-lg">Nueva Deuda</h3>

      <!-- Qui√©n es el ACREEDOR (a qui√©n se le debe) -->
      <label class="text-sm">Acreedor</label>
      <select id="deudaAcreedorSel" class="w-full border rounded p-2" required>
        <option value="">‚Äî Seleccionar ‚Äî</option>
        <option value="empresa">Empresa</option>
        <option value="brandon">Brandon</option>
        <option value="socia">Socia</option>
      </select>

      <!-- Qui√©n es el DEUDOR (qui√©n debe) -->
      <label class="text-sm mt-2">Deudor</label>
      <select id="deudaDeudorSel" class="w-full border rounded p-2" required>
        <option value="">‚Äî Seleccionar ‚Äî</option>
        <option value="empresa">Empresa</option>
        <option value="brandon">Brandon</option>
        <option value="socia">Socia</option>
      </select>

      <input
        type="number"
        id="deudaMonto"
        placeholder="Monto"
        step="0.01"
        min="0.01"
        required
        class="w-full border rounded p-2"
      />

      <input
        type="text"
        id="deudaDescripcion"
        placeholder="Descripci√≥n / Nota (opcional)"
        class="w-full border rounded p-2"
      />

      <input type="hidden" id="editingDeudaId" value="" />

      <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded">
        Guardar Deuda
      </button>

      <p id="deudaMsg" class="text-sm text-slate-500"></p>
    </form>

    <!-- Tabla de Deudas -->
    <div class="bg-white p-4 rounded shadow overflow-auto">
      <h3 class="font-semibold text-lg mb-2">Deudas</h3>
      <table class="w-full text-sm">
        <thead class="text-left">
          <tr>
            <th class="py-2">Acreedor</th>
            <th class="py-2">Deudor</th>
            <th class="py-2">Monto Inicial</th>
            <th class="py-2">Saldo</th>
            <th class="py-2">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbDeudas"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- Modal para ABONAR deuda -->
<div id="modalAbono" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white p-5 rounded shadow max-w-sm w-full">
    <h3 class="font-semibold mb-3">Registrar Abono</h3>
    <form id="formAbono" class="space-y-3">
      <input type="hidden" id="abonoDeudaId">
      <input type="hidden" id="abonoAcreedor">
      <input type="hidden" id="abonoDeudor">
      <input type="hidden" id="abonoSaldoActual">

      <div>
        <label class="block text-sm mb-1">Monto</label>
        <input type="number" id="abonoMonto" min="0.01" step="0.01" required class="w-full border rounded p-2">
      </div>

      <div>
        <label class="block text-sm mb-1">¬øQui√©n paga?</label>
        <select id="abonoPagador" required class="w-full border rounded p-2">
          <option value="">‚Äî Seleccionar ‚Äî</option>
          <option value="empresa">Empresa</option>
          <option value="brandon">Brandon</option>
          <option value="socia">Socia</option>
        </select>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button type="button" id="btnAbonoCancelar" class="px-3 py-2 rounded border">Cancelar</button>
        <button class="px-3 py-2 rounded bg-emerald-600 text-white">Abonar</button>
      </div>
    </form>
  </div>
</div>

       
<script type="module">
  // ========= Utilidad interna: crear movimientos y ajustar cajas =========
  async function registrarMovimiento({ tipo, cuenta, fecha, monto, desc }) {
    await addDoc(collection(db, "companies", companyId, "movements"), {
      tipo, cuenta, fecha, monto, desc, createdAt: serverTimestamp()
    });
  }

  async function aplicarTransferenciaCajas(delta) {
    // delta: { cajaEmpresa: +/-n, cajaBrandon: +/-n, cajaSocia: +/-n }
    await adjustBalances({
      cajaEmpresa: delta.cajaEmpresa || 0,
      cajaBrandon: delta.cajaBrandon || 0,
      cajaSocia: delta.cajaSocia || 0
    });
  }

  function hoyISO() {
    return new Date().toISOString().slice(0, 10);
  }

  // ========= CREAR / EDITAR DEUDA =========
  $("#formDeuda").addEventListener("submit", async (e) => {
    e.preventDefault();

    const editingId = $("#editingDeudaId").value || "";
    const acreedor = $("#deudaAcreedorSel").value;
    const deudor   = $("#deudaDeudorSel").value;
    const monto    = Number($("#deudaMonto").value || 0);
    const notas    = ($("#deudaDescripcion").value || "").trim();

    if (!acreedor || !deudor) return alert("Selecciona acreedor y deudor.");
    if (acreedor === deudor)  return alert("Acreedor y deudor no pueden ser el mismo.");
    if (monto <= 0)           return alert("El monto debe ser mayor a 0.");

    const baseDoc = {
      acreedor, deudor,
      montoInicial: monto,
      saldo: monto,
      notas: notas,
      updatedAt: serverTimestamp()
    };

    let deudaId;

    if (editingId) {
      await updateDoc(doc(db, "companies", companyId, "debts", editingId), baseDoc);
      deudaId = editingId;
      $("#editingDeudaId").value = "";
    } else {
      baseDoc.createdAt = serverTimestamp();
      const ref = await addDoc(collection(db, "companies", companyId, "debts"), baseDoc);
      deudaId = ref.id;
    }

    // ======= L√ìGICA DE CAJAS EN CREACI√ìN =======
    // Interpretaci√≥n: al generarse la deuda, el ACREEDOR "entrega" el dinero al DEUDOR.
    // Por ello, caja del ACREEDOR baja, caja del DEUDOR sube. Si el DEUDOR es empresa
    // y no tiene caja suficiente cuando hay que devolver (caso inverso), nuestro requerimiento
    // es que el faltante lo cubran socios 50/50, pero eso aplica cuando el que paga es la empresa
    // y no alcanza. Aqu√≠ en la creaci√≥n, quien entrega es el acreedor, no el deudor.
    //
    // Para cumplir con el requerimiento expresado de "si debe la empresa y su caja est√° en 0 se saca 50/50",
    // la situaci√≥n pr√°ctica donde se usa es en el ABONO (pago), no en la creaci√≥n.
    // Sin embargo, si t√∫ prefieres modelar que la creaci√≥n de deuda mueve efectivo,
    // hacemos la transferencia: Acreedor -> Deudor (egreso/ingreso).
    //
    // Movimientos y ajuste de balances:
    const fecha = hoyISO();
    const descMov = (notas ? `${notas} ‚Äî ` : "") + `Creaci√≥n deuda (${deudor} debe a ${acreedor})`;

    // Egreso acreedor
    await registrarMovimiento({
      tipo: "egreso",
      cuenta: acreedor === "empresa" ? "cajaEmpresa" : (acreedor === "brandon" ? "cajaBrandon" : "cajaSocia"),
      fecha, monto, desc: descMov
    });
    // Ingreso deudor
    await registrarMovimiento({
      tipo: "ingreso",
      cuenta: deudor === "empresa" ? "cajaEmpresa" : (deudor === "brandon" ? "cajaBrandon" : "cajaSocia"),
      fecha, monto, desc: descMov
    });

    // Ajustar balances en caliente (sin esperar recompute)
    const deltaCreacion = { cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0 };
    // restamos al acreedor
    if (acreedor === "empresa") deltaCreacion.cajaEmpresa -= monto;
    if (acreedor === "brandon") deltaCreacion.cajaBrandon -= monto;
    if (acreedor === "socia")   deltaCreacion.cajaSocia   -= monto;
    // sumamos al deudor
    if (deudor === "empresa")   deltaCreacion.cajaEmpresa += monto;
    if (deudor === "brandon")   deltaCreacion.cajaBrandon += monto;
    if (deudor === "socia")     deltaCreacion.cajaSocia   += monto;

    await aplicarTransferenciaCajas(deltaCreacion);

    $("#formDeuda").reset();
    $("#deudaMsg").textContent = "Deuda guardada correctamente.";
    setTimeout(() => ($("#deudaMsg").textContent = ""), 2000);

    // Recompute para refrescar KPIs y deudasTotales desde colecciones
    await recomputeBalances();
  });

  // ========= LISTAR / ABONAR / EDITAR / ELIMINAR =========
  function subscribeDeudas() {
    const qDeb = query(
      collection(db, "companies", companyId, "debts"),
      orderBy("createdAt", "desc")
    );

    const unsub = onSnapshot(qDeb, (snap) => {
      const tbody = $("#tbDeudas");
      tbody.innerHTML = "";

      snap.forEach((docu) => {
        const d = docu.data();
        const id = docu.id;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 capitalize">${d.acreedor}</td>
          <td class="py-2 capitalize">${d.deudor}</td>
          <td class="py-2">${money(d.montoInicial)}</td>
          <td class="py-2">${money(d.saldo)}</td>
          <td class="py-2 whitespace-nowrap">
            <button data-id="${id}" class="btn-abonar text-emerald-700 underline ml-1">Abonar</button>
            <button data-id="${id}" class="edit-deuda text-blue-600 underline ml-3">Editar</button>
            <button data-id="${id}" class="del-deuda text-red-600 underline ml-3">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Handlers
      $$(".btn-abonar").forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const snap = await getDoc(doc(db, "companies", companyId, "debts", id));
          if (!snap.exists()) return;

          const d = snap.data();
          // abrir modal pre-cargado
          $("#modalAbono").classList.remove("hidden");
          $("#modalAbono").classList.add("flex");

          $("#abonoDeudaId").value = id;
          $("#abonoAcreedor").value = d.acreedor;
          $("#abonoDeudor").value = d.deudor;
          $("#abonoSaldoActual").value = Number(d.saldo || 0);
          $("#abonoMonto").value = d.saldo || "";
          $("#abonoPagador").value = ""; // elige pagador
        };
      });

      $$(".del-deuda").forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          if (!confirm("Eliminar deuda? Esto recalcular√° balances.")) return;
          await deleteDoc(doc(db, "companies", companyId, "debts", id));
          await recomputeBalances();
        };
      });

      $$(".edit-deuda").forEach((btn) => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const snap = await getDoc(doc(db, "companies", companyId, "debts", id));
          if (!snap.exists()) return;

          const d = snap.data();
          $("#editingDeudaId").value = id;
          $("#deudaAcreedorSel").value = d.acreedor || "";
          $("#deudaDeudorSel").value = d.deudor || "";
          $("#deudaMonto").value = d.montoInicial || "";
          $("#deudaDescripcion").value = d.notas || "";

          // Ir a pesta√±a Deudas si no est√° visible
          const tabBtn = document.querySelector('[data-tab="deudas"]');
          if (tabBtn) tabBtn.click();
        };
      });
    });

    unsubscribers.push(unsub);
  }

  // ========= Cerrar modal de Abono =========
  $("#btnAbonoCancelar").addEventListener("click", () => {
    $("#modalAbono").classList.add("hidden");
    $("#modalAbono").classList.remove("flex");
    $("#formAbono").reset();
  });

  // ========= Procesar ABONO =========
  $("#formAbono").addEventListener("submit", async (e) => {
    e.preventDefault();

    const id      = $("#abonoDeudaId").value;
    const acre    = $("#abonoAcreedor").value; // a qui√©n se le paga (recibe)
    const deud    = $("#abonoDeudor").value;   // qui√©n debe (no afecta directo al abono)
    const saldo   = Number($("#abonoSaldoActual").value || 0);
    const monto   = Number($("#abonoMonto").value || 0);
    const pagador = $("#abonoPagador").value;

    if (monto <= 0) return alert("Monto inv√°lido.");
    if (monto > saldo) return alert("El abono no puede ser mayor al saldo.");
    if (!["empresa","brandon","socia"].includes(pagador)) return alert("Selecciona qui√©n paga.");

    // ======= L√ìGICA: QUI√âN PAGA Y DE D√ìNDE SALE =======
    // Regla adicional: si el pagador seleccionado es "empresa" pero su caja no alcanza,
    // el faltante se cubre 50/50 entre Brandon y Socia.
    const balSnap = await getDoc(doc(db, "companies", companyId, "state", "balances"));
    const balances = balSnap.exists() ? balSnap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0 };

    const delta = { cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0 };
    const fecha = hoyISO();
    const desc  = `Abono deuda (${deud} -> ${acre})`;

    // 1) Restar del pagador (con 50/50 si empresa insuficiente)
    if (pagador === "empresa") {
      const disponible = Number(balances.cajaEmpresa || 0);
      if (disponible >= monto) {
        // todo sale de empresa
        delta.cajaEmpresa -= monto;
        await registrarMovimiento({ tipo:"egreso", cuenta:"cajaEmpresa", fecha, monto, desc });
      } else {
        // empresa aporta lo que tiene, faltante 50/50 socios
        if (disponible > 0) {
          delta.cajaEmpresa -= disponible;
          await registrarMovimiento({ tipo:"egreso", cuenta:"cajaEmpresa", fecha, monto: disponible, desc });
        }
        const faltante = Number((monto - disponible).toFixed(2));
        const mitad = Number((faltante/2).toFixed(2));
        // para redondeos, que el centavo impar vaya a Brandon
        const resto = Number((faltante - mitad*2).toFixed(2));

        delta.cajaBrandon -= (mitad + resto);
        delta.cajaSocia   -=  mitad;

        await registrarMovimiento({ tipo:"egreso", cuenta:"cajaBrandon", fecha, monto: (mitad + resto), desc });
        await registrarMovimiento({ tipo:"egreso", cuenta:"cajaSocia",   fecha, monto:  mitad,          desc });
      }
    } else if (pagador === "brandon") {
      delta.cajaBrandon -= monto;
      await registrarMovimiento({ tipo:"egreso", cuenta:"cajaBrandon", fecha, monto, desc });
    } else if (pagador === "socia") {
      delta.cajaSocia -= monto;
      await registrarMovimiento({ tipo:"egreso", cuenta:"cajaSocia", fecha, monto, desc });
    }

    // 2) Sumar al acreedor (quien recibe el abono)
    if (acre === "empresa") {
      delta.cajaEmpresa += monto;
      await registrarMovimiento({ tipo:"ingreso", cuenta:"cajaEmpresa", fecha, monto, desc });
    } else if (acre === "brandon") {
      delta.cajaBrandon += monto;
      await registrarMovimiento({ tipo:"ingreso", cuenta:"cajaBrandon", fecha, monto, desc });
    } else if (acre === "socia") {
      delta.cajaSocia += monto;
      await registrarMovimiento({ tipo:"ingreso", cuenta:"cajaSocia", fecha, monto, desc });
    }

    // Aplicar a balances
    await aplicarTransferenciaCajas(delta);

    // Actualizar saldo de la deuda
    await updateDoc(doc(db, "companies", companyId, "debts", id), {
      saldo: Number((saldo - monto).toFixed(2)),
      updatedAt: serverTimestamp()
    });

    // Cerrar modal
    $("#modalAbono").classList.add("hidden");
    $("#modalAbono").classList.remove("flex");
    $("#formAbono").reset();

    // Recalcular KPIs/Deuda total
    await recomputeBalances();
  });

  // Exponer para que el resto del app pueda suscribirse (si ya llamas subscribeDeudas en onAuth, esto la reemplaza)
  window.subscribeDeudas = subscribeDeudas;
</script>






        <!-- METAS -->
        <section id="tab-metas" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formMeta" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Crear Meta</h3>
              <select id="metaTipo" class="w-full border rounded p-2">
                <option value="negocio">Negocio</option>
                <option value="brandon">Brandon</option>
                <option value="socia">Socia</option>
              </select>
              <input type="text" id="metaNombre" placeholder="Nombre de la meta" required class="w-full border rounded p-2">
              <input type="number" id="metaObjetivo" placeholder="Objetivo ($)" step="0.01" min="0" required class="w-full border rounded p-2">
              <textarea id="metaNotas" placeholder="Notas" class="w-full border rounded p-2"></textarea>
              <input type="hidden" id="editingMetaId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Crear Meta</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Metas y Avance</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Meta</th><th>Tipo</th><th>Objetivo</th><th>Acumulado</th><th>%</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbMetas"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MOVIMIENTOS -->
        <section id="tab-movimientos" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <form id="formMovimiento" class="bg-white p-4 rounded shadow space-y-2">
              <h3 class="font-semibold text-lg">Nuevo Movimiento (ingreso/egreso)</h3>
              <select id="movTipo" class="w-full border rounded p-2">
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
              </select>
              <select id="movCuenta" class="w-full border rounded p-2">
                <option value="cajaEmpresa">Caja Empresa</option>
                <option value="cajaBrandon">Caja Brandon</option>
                <option value="cajaSocia">Caja Socia</option>
                <option value="inversiones">Inversiones</option>
                <option value="deudasTotales">Deudas Totales</option>
              </select>
              <input type="date" id="movFecha" class="w-full border rounded p-2">
              <input type="number" id="movMonto" placeholder="Monto" step="0.01" min="0" class="w-full border rounded p-2">
              <input type="text" id="movDesc" placeholder="Descripci√≥n" class="w-full border rounded p-2">
              <input type="hidden" id="editingMovId" value="">
              <button class="w-full bg-emerald-600 text-white py-2 rounded">Guardar Movimiento</button>
            </form>

            <div class="bg-white p-4 rounded shadow overflow-auto">
              <h3 class="font-semibold text-lg mb-2">Historial de Movimientos</h3>
              <table class="w-full text-sm">
                <thead class="text-left">
                  <tr>
                    <th>Fecha</th><th>Tipo</th><th>Cuenta</th><th>Monto</th><th>Desc</th><th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbMovimientos"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ESTAD√çSTICAS -->
        <section id="tab-estadisticas" class="tab hidden mt-4">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded shadow" style="height:320px">
              <h3 class="font-semibold mb-2">Ingresos vs Gastos (√∫ltimos 90 d√≠as)</h3>
              <canvas id="chartIG" height="280"></canvas>
            </div>
            <div class="bg-white p-4 rounded shadow" style="height:320px">
              <h3 class="font-semibold mb-2">Utilidad y Margen por venta</h3>
              <canvas id="chartUtilidad" height="280"></canvas>
            </div>
          </div>
        </section>

      </div>
    </div>
  </div>

  <!-- =========================
       SCRIPT: Firebase + L√≥gica (PARTE 1)
       ========================= -->
  <script type="module">
    // --------- FIREBASE CONFIG (usa el tuyo, aqu√≠ dejo el que ya usabas) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCTFSlLoKv6KKujTqjMeMjNc-AlKQ2-rng",
      authDomain: "duostyle01-611b9.firebaseapp.com",
      projectId: "duostyle01-611b9",
      storageBucket: "duostyle01-611b9.firebasestorage.app",
      messagingSenderId: "4630065257",
      appId: "1:4630065257:web:11b7b0a0ac2fa776bbf2f8",
      measurementId: "G-FW6QEJMZKT"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, addDoc, getDocs, onSnapshot, collection,
      query, orderBy, serverTimestamp, updateDoc, increment, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.db = db; window.auth = auth;

    // ---- Helpers UI
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const money = n => `$${Number(n||0).toLocaleString('es-CO', {maximumFractionDigits: 2})}`;

    // ---- State
    let currentUser = null;
    let companyId = null;
    let unsubscribers = [];

    // ---- Auth handlers
    $("#loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = $("#loginEmail").value.trim();
      const pass = $("#loginPass").value.trim();
      await signInWithEmailAndPassword(auth, email, pass);
    });

    $("#registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = $("#regName").value.trim();
      const email = $("#regEmail").value.trim();
      const pass = $("#regPass").value.trim();
      const ahorroPct = 0;

      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: name });
      await setDoc(doc(db, "users", cred.user.uid), { displayName: name, email, ahorroSugeridoPct: ahorroPct });

      // Crear company doc por defecto
      companyId = `${cred.user.uid}-company`;
      await setDoc(doc(db, "companies", companyId), {
        name: "Joyer√≠a ‚Äî Empresa",
        owners: [{ uid: cred.user.uid, name }],
        mandatoryDebtPct: 0.10
      });
      await setDoc(doc(db, "companies", companyId, "state", "balances"), {
        cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
      });
    });

    $("#btnLogout").addEventListener("click", () => signOut(auth));

    // ---- onAuth
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      unsubscribers.forEach(u => u && u());
      unsubscribers = [];
      if (!user) {
        $("#authView").classList.remove("hidden");
        $("#mainView").classList.add("hidden");
        return;
      }
      $("#authView").classList.add("hidden");
      $("#mainView").classList.remove("hidden");

      companyId = `${user.uid}-company`;
      const compRef = doc(db, "companies", companyId);
      const snap = await getDoc(compRef);
      if (!snap.exists()) {
        await setDoc(compRef, {
          name: "Joyer√≠a ‚Äî Empresa",
          owners: [{ uid: user.uid, name: user.displayName || "Owner" }],
          mandatoryDebtPct: 0.10
        });
        await setDoc(doc(db, "companies", companyId, "state", "balances"), {
          cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
        });
      }
      $("#companyName").textContent = (await getDoc(compRef)).data().name;

      // Setup UI & subscriptions
      setupTabs();
      setupVentaFormHints();
      setupCharts();
      setupVentaToggle();
      setupPerfilButton();

      subscribeKPIs();
      subscribeVentas();
      subscribeGastos();
      subscribeDeudas();
      subscribeMetas();
      subscribeMovimientos();

      // Listen to core collections to recompute balances
      const qSales = query(collection(db, "companies", companyId, "sales"), orderBy("createdAt","desc"));
      const qExp = query(collection(db, "companies", companyId, "expenses"), orderBy("createdAt","desc"));
      const qDeb = query(collection(db, "companies", companyId, "debts"), orderBy("createdAt","desc"));
      const qMov = query(collection(db, "companies", companyId, "movements"), orderBy("createdAt","desc"));
      const qGoals = query(collection(db, "companies", companyId, "goals"), orderBy("createdAt","desc"));

      unsubscribers.push(onSnapshot(qSales, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qExp, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qDeb, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qMov, () => recomputeBalances()));
      unsubscribers.push(onSnapshot(qGoals, () => recomputeBalances()));

      await recomputeBalances();
    });

    // ---- Tabs
    function setupTabs() {
      $$(".tab-btn").forEach(btn => {
        btn.onclick = () => {
          const id = btn.dataset.tab;
          $$(".tab-btn").forEach(b => b.classList.remove("bg-slate-900","text-white"));
          btn.classList.add("bg-slate-900","text-white");
          $$(".tab").forEach(t => t.classList.add("hidden"));
          $(`#tab-${id}`).classList.remove("hidden");
        };
      });
    }

    // ---- KPIs (subscribe balances doc)
    function subscribeKPIs() {
      const ref = doc(db, "companies", companyId, "state", "balances");
      const unsub = onSnapshot(ref, snap => {
        const d = snap.exists() ? snap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0, deudasTotales:0 };
        $("#kpiCajaEmpresa").textContent = money(d.cajaEmpresa);
        $("#kpiCajaBrandon").textContent = money(d.cajaBrandon);
        $("#kpiCajaSocia").textContent = money(d.cajaSocia);
        $("#kpiDeudas").textContent = money(d.deudasTotales);
      });
      unsubscribers.push(unsub);
    }

        // ------------------------------------------------
    // computePaidBy: decide qui√©n pag√≥ el costo y crear movs si needed
    // ------------------------------------------------
    async function computePaidBy(financiadoPor, amount, createMovements = false) {
      try {
        // read current balances to know cu√°nto tiene la empresa
        const balSnap = await getDoc(doc(db, "companies", companyId, "state", "balances"));
        const balances = balSnap.exists() ? balSnap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0 };
        const empresaCaja = Number(balances.cajaEmpresa || 0);

        let pb = { empresa: 0, brandon: 0, socia: 0 };

        if (financiadoPor === "brandon") {
          // Brandon financia -> full a Brandon
          pb.brandon = Number(amount);
        } else if (financiadoPor === "socia") {
          // Socia financia -> full a Socia
          pb.socia = Number(amount);
        } else { // financiadoPor === 'empresa'
          // Si la empresa tiene suficiente, cubre todo
          if (empresaCaja >= amount) {
            pb.empresa = Number(amount);
          } else {
            // Empresa cubre lo que tenga, el resto se divide 50/50 entre Brandon y Socia
            pb.empresa = Number(Math.max(0, empresaCaja).toFixed(2));
            const shortage = Number((amount - pb.empresa).toFixed(2));
            const half = Number((shortage/2).toFixed(2));
            pb.brandon = half;
            pb.socia = half;
            // ajuste de resto por centavos
            const remainder = Number((shortage - (half*2)).toFixed(2));
            if (remainder !== 0) pb.brandon = Number((pb.brandon + remainder).toFixed(2));
          }
        }

        // Create movements to reflect partners' advances (egreso) if requested and there are advances
        // Nota: para la parte de empresa no creamos movimiento aqu√≠; las entradas/salidas de empresa vienen de la venta/gasto y del recompute.
        if (createMovements) {
          const moves = [];
          const today = new Date().toISOString().slice(0,10);
          if (pb.brandon && pb.brandon > 0) {
            moves.push(addDoc(collection(db, "companies", companyId, "movements"), {
              tipo: "egreso",
              cuenta: "cajaBrandon",
              fecha: today,
              monto: pb.brandon,
              desc: `Anticipo de Brandon para costo (${financiadoPor})`,
              createdAt: serverTimestamp()
            }));
          }
          if (pb.socia && pb.socia > 0) {
            moves.push(addDoc(collection(db, "companies", companyId, "movements"), {
              tipo: "egreso",
              cuenta: "cajaSocia",
              fecha: today,
              monto: pb.socia,
              desc: `Anticipo de Socia para costo (${financiadoPor})`,
              createdAt: serverTimestamp()
            }));
          }
          if (moves.length) await Promise.all(moves);
        }

        return pb;
      } catch (err) {
        console.error("computePaidBy error:", err);
        const half = Number((amount/2).toFixed(2));
        return { empresa: 0, brandon: half, socia: half };
      }
    }

   
    // ------------------------------------------------
// recomputeBalances: recalcula todo desde cero (movimientos, ventas, gastos, deudas, metas)
// ------------------------------------------------

async function recomputeBalances() {
  try {
    // base: iniciar todo en 0
    const base = { cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0 };

    // helper: derive paidBy si no existe en documento (fallback)
    function derivePaidBy(asig, cost) {
      if (!asig) return { empresa: 0, brandon: 0, socia: 0 };
      if (asig.paidBy) return {
        empresa: Number(asig.paidBy.empresa || 0),
        brandon: Number(asig.paidBy.brandon || 0),
        socia: Number(asig.paidBy.socia || 0)
      };
      const fp = asig.financiadoPor || "empresa";
      if (fp === "brandon") return { empresa: 0, brandon: Number(cost), socia: 0 };
      if (fp === "socia") return { empresa: 0, brandon: 0, socia: Number(cost) };
      return { empresa: Number(cost), brandon: 0, socia: 0 };
    }
   /*
    // 1) Movements (aplican directamente)
    const movSnap = await getDocs(collection(db, "companies", companyId, "movements"));
    movSnap.forEach(snap => {
      const m = snap.data();
      const monto = Number(m.monto || 0);
      const sign = (m.tipo === "ingreso") ? 1 : -1;
      const delta = sign * monto;
      if (m.cuenta === "cajaEmpresa") base.cajaEmpresa += delta;
      if (m.cuenta === "cajaBrandon") base.cajaBrandon += delta;
      if (m.cuenta === "cajaSocia") base.cajaSocia += delta;
      if (m.cuenta === "inversiones") base.inversiones += delta;
      if (m.cuenta === "deudasTotales") base.deudasTotales += delta;
    }); 
    */

    // 2) Sales: distribuimos el reembolso del costo y la utilidad correctamente
    const salesSnap = await getDocs(collection(db, "companies", companyId, "sales"));
    salesSnap.forEach(snap => {
      const s = snap.data();
      const price = Number(s.precio || 0);
      const cost = Number(s.costo || 0);
      const utilidad = Number(s.utilidad || (price - cost) || 0);
      const a = s.asignaciones || {};

      // derivar qui√©n pag√≥ el costo (paidBy) o fallback
      const pb = derivePaidBy(a, cost);

      if (a.manualMode) {
        // Modo manual: respetar lo que el usuario haya puesto
        if (a.reinversion) base.inversiones += Number(a.reinversion || 0);
        if (a.brandon) base.cajaBrandon += Number(a.brandon || 0);
        if (a.socia) base.cajaSocia += Number(a.socia || 0);
        if (a.pagoDeuda) base.deudasTotales -= Number(a.pagoDeuda || 0);
      } else {
        // Modo autom√°tico:
        // 1) Reembolsos: acreditar a quienes adelantaron el costo
        if (pb.brandon && pb.brandon > 0) base.cajaBrandon += Number(pb.brandon);
        if (pb.socia && pb.socia > 0) base.cajaSocia += Number(pb.socia);
        // si empresa aport√≥ parte del costo, esa porci√≥n se reparte 50/50 a socios
        if (pb.empresa && pb.empresa > 0) {
          const halfInv = Number((pb.empresa / 2).toFixed(2));
          base.cajaBrandon += halfInv;
          base.cajaSocia += halfInv;
        }
        // 2) Reparto de utilidad 50/50
        if (utilidad > 0) {
          const halfU = Number((utilidad / 2).toFixed(2));
          base.cajaBrandon += halfU;
          base.cajaSocia += halfU;
        }
      }

      // reinversiones/pagoDeuda opcionales (tambi√©n aplicables en autom√°tico si est√°n presentes)
      if (!a.manualMode) {
        if (a.reinversion) { base.inversiones += Number(a.reinversion || 0); }
        if (a.pagoDeuda) { base.deudasTotales -= Number(a.pagoDeuda || 0); }
      }
    });

    // 3) Expenses
    const expSnap = await getDocs(collection(db, "companies", companyId, "expenses"));
    expSnap.forEach(snap => {
      const g = snap.data();
      const monto = Number(g.monto || 0);
      if (g.paidDistribution) {
        base.cajaEmpresa -= Number(g.paidDistribution.empresa || 0);
        base.cajaBrandon -= Number(g.paidDistribution.brandon || 0);
        base.cajaSocia -= Number(g.paidDistribution.socia || 0);
      } else {
        if (g.pagadoPor === "empresa") base.cajaEmpresa -= monto;
        if (g.pagadoPor === "brandon") base.cajaBrandon -= monto;
        if (g.pagadoPor === "socia") base.cajaSocia -= monto;
      }
    });

    // 4) Debts (sum saldos)
    const debtsSnap = await getDocs(collection(db, "companies", companyId, "debts"));
    debtsSnap.forEach(snap => {
      const d = snap.data();
      const saldo = Number(d.saldo || d.montoInicial || 0);
      base.deudasTotales += saldo;
    });

    // 5) Goals
    const goalsSnap = await getDocs(collection(db, "companies", companyId, "goals"));
    goalsSnap.forEach(snap => {
      const g = snap.data();
      const acum = Number(g.acumulado || 0);
      if (g.tipo === "negocio") base.cajaEmpresa -= acum;
      if (g.tipo === "brandon") base.cajaBrandon -= acum;
      if (g.tipo === "socia") base.cajaSocia -= acum;
    });

    // normalizar floats
    for (let k of Object.keys(base)) base[k] = Number(base[k].toFixed(2));

    // evitar cajaEmpresa negativa: repartir d√©ficit 50/50 entre Brandon y Socia
    if (base.cajaEmpresa < 0) {
      const deficit = -base.cajaEmpresa;
      base.cajaEmpresa = 0;
      const halfDef = Number((deficit / 2).toFixed(2));
      base.cajaBrandon -= halfDef;
      base.cajaSocia -= halfDef;
    }

    // guardar balances absolutos
    await setDoc(doc(db, "companies", companyId, "state", "balances"), base, { merge: true });

  } catch (err) {
    console.error("recomputeBalances error:", err);
  }
}


    // small helper: adjustBalances incremental (kept for rare direct ops)
    async function adjustBalances({ cajaEmpresa=0, cajaBrandon=0, cajaSocia=0, deudasTotales=0, inversiones=0 }) {
      await setDoc(doc(db, "companies", companyId, "state", "balances"), {
        cajaEmpresa: increment(cajaEmpresa),
        cajaBrandon: increment(cajaBrandon),
        cajaSocia: increment(cajaSocia),
        deudasTotales: increment(deudasTotales),
        inversiones: increment(inversiones)
      }, { merge: true });
    }

    // ---------------------------
    // VENTAS (submit)
    // ---------------------------
    function setupVentaFormHints() {
      const costo = $("#ventaCosto");
      const precio = $("#ventaPrecio");
      async function updateResumen() {
        const c = Number(costo.value||0), p = Number(precio.value||0);
        const util = p - c;
        const margen = p ? (util / p) : 0;
        $("#ventaResumen").textContent = `Utilidad: ${money(util)} (${(margen*100).toFixed(1)}%)`;
        try {
          const snap = await getDoc(doc(db, "users", currentUser.uid));
          const pct = (snap.exists() ? (snap.data().ahorroSugeridoPct || 0) : 0);
          const asigB = Number($("#asigBrandon").value||0);
          const sug = asigB * pct;
          $("#sugerenciaAhorro").textContent = pct ? `Sugerencia: aparta ${money(sug)} (${(pct*100).toFixed(0)}% de lo asignado a Brandon) hacia ahorros.` : "";
        } catch (err) {
          $("#sugerenciaAhorro").textContent = "";
        }
      }
      ["input","change"].forEach(ev => {
        costo.addEventListener(ev, updateResumen);
        precio.addEventListener(ev, updateResumen);
        $("#asigBrandon").addEventListener(ev, updateResumen);
      });
    }

    function setupVentaToggle() {
      $("#ventaManualToggle").addEventListener("change", () => {
        const on = $("#ventaManualToggle").checked;
        if (on) {
          $("#manualDistribFields").classList.remove("hidden");
          $("#autoDistribNote").classList.add("hidden");
        } else {
          $("#manualDistribFields").classList.add("hidden");
          $("#autoDistribNote").classList.remove("hidden");
          // limpiar
          $("#asigReinv").value = "";
          $("#asigBrandon").value = "";
          $("#asigSocia").value = "";
          $("#asigPagoDeuda").value = "";
        }
      });
    }

   $("#formVenta").addEventListener("submit", async (e) => {
  e.preventDefault();
  const editingId = $("#editingSaleId").value || "";
  const date = $("#ventaFecha").value || new Date().toISOString().slice(0,10);
  const producto = $("#ventaProducto").value.trim();
  const costo = Number($("#ventaCosto").value||0);
  const precio = Number($("#ventaPrecio").value||0);
  const notas = $("#ventaNotas").value.trim();
  const utilidad = precio - costo;
  const margen = precio ? utilidad / precio : 0;
  const financiadoPor = $("#ventaFinanciadaPor").value;
  const manualMode = $("#ventaManualToggle").checked;

  const asig = {
    manualMode,
    financiadoPor,
    reinversion: Number($("#asigReinv").value||0),
    brandon: Number($("#asigBrandon").value||0),
    socia: Number($("#asigSocia").value||0),
    pagoDeuda: Number($("#asigPagoDeuda").value||0)
  };

  if (precio <= 0) { alert("El precio debe ser mayor a 0"); return; }
  if (costo < 0) { alert("El costo no puede ser negativo"); return; }

  // --- compute paidBy ---
  const createMovs = !editingId;
  let paidBy = await computePaidBy(financiadoPor, costo, createMovs);

  // üîπ Correcci√≥n clave:
  // si la inversi√≥n la hizo la EMPRESA, no se devuelve el costo.
  // El costo ya se descuenta de la cajaEmpresa en recomputeBalances,
  // por lo tanto anulamos esa devoluci√≥n.
  if (financiadoPor === "empresa") {
    paidBy = { empresa: 0, brandon: 0, socia: 0 };
  }

  asig.paidBy = paidBy;

  if (editingId) {
    await updateDoc(doc(db, "companies", companyId, "sales", editingId), {
      date, producto, costo, precio, utilidad, margen, notas,
      asignaciones: asig, updatedAt: serverTimestamp()
    });
  } else {
    await addDoc(collection(db, "companies", companyId, "sales"), {
      date, producto, costo, precio, utilidad, margen, notas,
      asignaciones: asig, createdAt: serverTimestamp()
    });
  }

  // recompute balances robustly after operation
  await recomputeBalances();

  $("#editingSaleId").value = "";
  e.target.reset();
  $("#manualDistribFields").classList.add("hidden");
  $("#autoDistribNote").classList.remove("hidden");
});


    // ---------------------------
    // GASTOS (submit)
    // ---------------------------
    $("#formGasto").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingGastoId").value || "";
      const date = $("#gastoFecha").value || new Date().toISOString().slice(0,10);
      const categoria = $("#gastoCat").value.trim();
      const monto = Number($("#gastoMonto").value||0);
      const descripcion = $("#gastoDesc").value.trim();
      const pagadoPor = $("#gastoPagadoPor").value;

      // compute distribution and create movements if new
      const createMovs = !editingId;
      const paidDistribution = await computePaidBy(pagadoPor, monto, createMovs);

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "expenses", editingId), {
          date, categoria, monto, descripcion, pagadoPor, paidDistribution, updatedAt: serverTimestamp()
        });
        $("#editingGastoId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "expenses"), {
          date, categoria, monto, descripcion, pagadoPor, paidDistribution, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });
    // ---------------------------
    // SUBSCRIPTIONS: VENTAS / GASTOS (render + handlers)
    // ---------------------------
    function subscribeVentas() {
      const qSales = query(collection(db, "companies", companyId, "sales"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qSales, (snap) => {
        const tbody = $("#tbVentas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const s = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.date}</td>
            <td>${s.producto}</td>
            <td>${money(s.precio)}</td>
            <td>${money(s.costo)}</td>
            <td>${money(s.utilidad)}</td>
            <td>${(s.margen*100).toFixed(1)}%</td>
            <td>
              <button data-id="${id}" class="edit-sale text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-sale text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-sale").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar venta? Esto recalcular√° balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "sales", id));
            await recomputeBalances();
          };
        });

        $$(".edit-sale").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ref = doc(db, "companies", companyId, "sales", id);
            const snap = await getDoc(ref);
            if (!snap.exists()) return alert("Documento no encontrado.");
            const data = snap.data();
            $("#editingSaleId").value = id;
            $("#ventaFecha").value = data.date || "";
            $("#ventaProducto").value = data.producto || "";
            $("#ventaCosto").value = data.costo || "";
            $("#ventaPrecio").value = data.precio || "";
            $("#ventaNotas").value = data.notas || "";
            const a = data.asignaciones || {};
            $("#ventaFinanciadaPor").value = a.financiadoPor || "empresa";
            $("#ventaManualToggle").checked = !!a.manualMode;
            if (a.manualMode) {
              $("#manualDistribFields").classList.remove("hidden"); $("#autoDistribNote").classList.add("hidden");
              $("#asigReinv").value = a.reinversion || ""; $("#asigBrandon").value = a.brandon || "";
              $("#asigSocia").value = a.socia || ""; $("#asigPagoDeuda").value = a.pagoDeuda || "";
            } else {
              $("#manualDistribFields").classList.add("hidden"); $("#autoDistribNote").classList.remove("hidden");
              $("#asigReinv").value = a.reinversion || ""; $("#asigPagoDeuda").value = a.pagoDeuda || "";
              $("#asigBrandon").value = ""; $("#asigSocia").value = "";
            }
            document.querySelector('[data-tab="ventas"]').click();
          };
        });

        refreshCharts();
      });
      unsubscribers.push(unsub);
    }

    function subscribeGastos() {
      const qExp = query(collection(db, "companies", companyId, "expenses"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qExp, (snap) => {
        const tbody = $("#tbGastos"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const g = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${g.date}</td><td>${g.categoria}</td><td>${money(g.monto)}</td><td>${g.pagadoPor}</td><td>${g.descripcion||""}</td>
            <td>
              <button data-id="${id}" class="edit-gasto text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-gasto text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-gasto").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar gasto? Esto recalcular√° balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "expenses", id));
            await recomputeBalances();
          };
        });

        $$(".edit-gasto").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "expenses", id));
            if (!snap.exists()) return;
            const g = snap.data();
            $("#editingGastoId").value = id;
            $("#gastoFecha").value = g.date || "";
            $("#gastoCat").value = g.categoria || "";
            $("#gastoMonto").value = g.monto || "";
            $("#gastoDesc").value = g.descripcion || "";
            $("#gastoPagadoPor").value = g.pagadoPor || "empresa";
            document.querySelector('[data-tab="gastos"]').click();
          };
        });

        refreshCharts();
      });
      unsubscribers.push(unsub);
    }

    // ------------------------------------------------
    // DEUDAS / METAS / MOVIMIENTOS (handlers y subscribes)
    // ------------------------------------------------
    // --- DEUDAS (submit + subscribe)
    $("#formDeuda").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingDeudaId").value || "";
      const tipo = $("#deudaTipo").value;
      const acreedor = $("#deudaAcreedor").value.trim();
      const monto = Number($("#deudaMonto").value||0);
      const notas = $("#deudaNotas").value.trim();

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "debts", editingId), {
          tipo, acreedor, montoInicial: monto, saldo: monto, notas, updatedAt: serverTimestamp()
        });
        $("#editingDeudaId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "debts"), {
          tipo, acreedor, montoInicial: monto, saldo: monto, notas, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });

    function subscribeDeudas() {
      const qDeb = query(collection(db, "companies", companyId, "debts"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qDeb, (snap) => {
        const tbody = $("#tbDeudas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const d = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.acreedor}</td><td>${d.tipo}</td><td>${money(d.saldo)}</td>
            <td>
              <input type="number" step="0.01" min="0" placeholder="Abono" class="border rounded p-1 w-28" id="abono-${id}">
              <button data-id="${id}" class="btn-abonar text-emerald-700 underline ml-1">Abonar</button>
              <button data-id="${id}" class="edit-deuda text-blue-600 underline ml-2">Editar</button>
              <button data-id="${id}" class="del-deuda text-red-600 underline ml-2">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".btn-abonar").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ab = Number($(`#abono-${id}`).value||0);
            if (ab <= 0) return;
            const ref = doc(db, "companies", companyId, "debts", id);
            const snap = await getDoc(ref);
            const saldo = (snap.data().saldo || 0) - ab;
            await updateDoc(ref, { saldo: Math.max(0, saldo) });
            await recomputeBalances();
            $(`#abono-${id}`).value = "";
          };
        });

        $$(".del-deuda").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar deuda? Esto recalcular√° balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "debts", id));
            await recomputeBalances();
          };
        });

        $$(".edit-deuda").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "debts", id));
            if (!snap.exists()) return;
            const d = snap.data();
            $("#editingDeudaId").value = id;
            $("#deudaTipo").value = d.tipo || "a_proveedor";
            $("#deudaAcreedor").value = d.acreedor || "";
            $("#deudaMonto").value = d.montoInicial || "";
            $("#deudaNotas").value = d.notas || "";
            document.querySelector('[data-tab="deudas"]').click();
          };
        });

      });
      unsubscribers.push(unsub);
    }

    // --- METAS
    $("#formMeta").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingMetaId").value || "";
      const tipo = $("#metaTipo").value;
      const nombre = $("#metaNombre").value.trim();
      const objetivoMonto = Number($("#metaObjetivo").value||0);
      const notas = $("#metaNotas").value.trim();

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "goals", editingId), {
          tipo, nombre, objetivoMonto, updatedAt: serverTimestamp()
        });
        $("#editingMetaId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "goals"), {
          tipo, nombre, objetivoMonto, acumulado: 0, notas, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });

    function subscribeMetas() {
      const qGoals = query(collection(db, "companies", companyId, "goals"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(qGoals, (snap) => {
        const tbody = $("#tbMetas"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const g = docu.data(); const id = docu.id;
          const pct = g.objetivoMonto ? (g.acumulado/g.objetivoMonto)*100 : 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${g.nombre}</td><td>${g.tipo}</td><td>${money(g.objetivoMonto)}</td><td>${money(g.acumulado)}</td><td>${pct.toFixed(0)}%</td>
            <td>
              <input type="number" step="0.01" min="0" placeholder="$" class="border rounded p-1 w-24" id="abmeta-${id}">
              <button data-id="${id}" class="btn-abonar-meta text-emerald-700 underline ml-1">Abonar</button>
              <button data-id="${id}" class="edit-meta text-blue-600 underline ml-2">Editar</button>
              <button data-id="${id}" class="del-meta text-red-600 underline ml-2">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".btn-abonar-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ab = Number($(`#abmeta-${id}`).value||0);
            if (ab <= 0) return;
            const ref = doc(db, "companies", companyId, "goals", id);
            const snap = await getDoc(ref);
            const acum = (snap.data().acumulado || 0) + ab;
            await updateDoc(ref, { acumulado: acum });
            await recomputeBalances();
            $(`#abmeta-${id}`).value = "";
          };
        });

        $$(".del-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar meta?")) return;
            await deleteDoc(doc(db, "companies", companyId, "goals", id));
            await recomputeBalances();
          };
        });

        $$(".edit-meta").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "goals", id));
            if (!snap.exists()) return;
            const g = snap.data();
            $("#editingMetaId").value = id;
            $("#metaTipo").value = g.tipo || "negocio";
            $("#metaNombre").value = g.nombre || "";
            $("#metaObjetivo").value = g.objetivoMonto || "";
            $("#metaNotas").value = g.notas || "";
            document.querySelector('[data-tab="metas"]').click();
          };
        });

      });
      unsubscribers.push(unsub);
    }

    // --- MOVIMIENTOS
    $("#formMovimiento").addEventListener("submit", async (e) => {
      e.preventDefault();
      const editingId = $("#editingMovId").value || "";
      const tipo = $("#movTipo").value;
      const cuenta = $("#movCuenta").value;
      const fecha = $("#movFecha").value || new Date().toISOString().slice(0,10);
      const monto = Number($("#movMonto").value||0);
      const desc = $("#movDesc").value || "";

      if (monto <= 0) { alert("Monto debe ser mayor que 0"); return; }

      if (editingId) {
        await updateDoc(doc(db, "companies", companyId, "movements", editingId), {
          tipo, cuenta, fecha, monto, desc, updatedAt: serverTimestamp()
        });
        $("#editingMovId").value = "";
      } else {
        await addDoc(collection(db, "companies", companyId, "movements"), {
          tipo, cuenta, fecha, monto, desc, createdAt: serverTimestamp()
        });
      }

      await recomputeBalances();
      e.target.reset();
    });

    function subscribeMovimientos() {
      const q = query(collection(db, "companies", companyId, "movements"), orderBy("createdAt","desc"));
      const unsub = onSnapshot(q, snap => {
        const tbody = $("#tbMovimientos"); tbody.innerHTML = "";
        snap.forEach(docu => {
          const m = docu.data(); const id = docu.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.fecha}</td><td>${m.tipo}</td><td>${m.cuenta}</td><td>${money(m.monto)}</td><td>${m.desc||""}</td>
            <td>
              <button data-id="${id}" class="edit-mov text-blue-600 underline mr-2">Editar</button>
              <button data-id="${id}" class="del-mov text-red-600 underline">Eliminar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        $$(".del-mov").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            if (!confirm("Eliminar movimiento? Esto recalcular√° balances.")) return;
            await deleteDoc(doc(db, "companies", companyId, "movements", id));
            await recomputeBalances();
          };
        });

        $$(".edit-mov").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const snap = await getDoc(doc(db, "companies", companyId, "movements", id));
            if (!snap.exists()) return;
            const m = snap.data();
            $("#editingMovId").value = id;
            $("#movTipo").value = m.tipo || "ingreso";
            $("#movCuenta").value = m.cuenta || "cajaEmpresa";
            $("#movFecha").value = m.fecha || "";
            $("#movMonto").value = m.monto || "";
            $("#movDesc").value = m.desc || "";
            document.querySelector('[data-tab="movimientos"]').click();
          };
        });

      });
      unsubscribers.push(unsub);
    }

    // ------------------------------------------------
    // GR√ÅFICAS (Chart.js) - destrucci√≥n / recreaci√≥n para evitar duplicaci√≥n
    // ------------------------------------------------
    let chartIG = null, chartUtilidad = null;
    function setupCharts() {
      try { if (chartIG) chartIG.destroy(); } catch(e){}
      try { if (chartUtilidad) chartUtilidad.destroy(); } catch(e){}

      chartIG = new Chart($("#chartIG"), {
        type: 'line',
        data: { labels: [], datasets: [
          { label: "Ingresos", data: [], borderColor: "#16a34a", backgroundColor: "#16a34a22", fill: true },
          { label: "Gastos", data: [], borderColor: "#ef4444", backgroundColor: "#ef444422", fill: true }
        ]},
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
      });

      chartUtilidad = new Chart($("#chartUtilidad"), {
        type: 'bar',
        data: { labels: [], datasets: [
          { label: "Utilidad", data: [], backgroundColor: "#0ea5e9" },
          { label: "Margen %", data: [], backgroundColor: "#f59e0b", yAxisID: 'y1' }
        ]},
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { beginAtZero: true }, y1: { beginAtZero: true, position: 'right', ticks: { callback: v => v + "%" } } }
        }
      });
    }

    async function refreshCharts() {
      try {
        const today = new Date();
        const from = new Date(today.getTime() - 90*24*3600*1000);
        function fmt(d){ return d.toISOString().slice(0,10); }

        const salesSnap = await getDocs(collection(db, "companies", companyId, "sales"));
        const expSnap = await getDocs(collection(db, "companies", companyId, "expenses"));

        const byDateIn = {}, byDateOut = {};
        salesSnap.forEach(s => {
          const d = s.data();
          byDateIn[d.date] = (byDateIn[d.date]||0) + Number(d.precio||0);
        });
        expSnap.forEach(g => {
          const d = g.data();
          byDateOut[d.date] = (byDateOut[d.date]||0) + Number(d.monto||0);
        });

        const labels = [];
        for (let t=from; t<=today; t = new Date(t.getTime()+24*3600*1000)) labels.push(fmt(t));
        const ingresos = labels.map(l => byDateIn[l]||0);
        const gastos = labels.map(l => byDateOut[l]||0);

        chartIG.data.labels = labels;
        chartIG.data.datasets[0].data = ingresos;
        chartIG.data.datasets[1].data = gastos;
        chartIG.update();

        // utilidad por venta
        const ventas = []; salesSnap.forEach(s => ventas.push(s.data()));
        ventas.sort((a,b)=> (a.date < b.date ? -1:1));
        const ult = ventas.slice(-30);
        chartUtilidad.data.labels = ult.map(v => v.producto || "");
        chartUtilidad.data.datasets[0].data = ult.map(v => v.utilidad || 0);
        chartUtilidad.data.datasets[1].data = ult.map(v => Number(((v.margen||0)*100).toFixed(1)));
        chartUtilidad.update();
      } catch (err) {
        console.error("refreshCharts error:", err);
      }
    }

    // Profile / settings
    $("#btnSelectCompany").addEventListener("click", async () => {
      const name = prompt("Nombre de empresa", "Joyer√≠a ‚Äî Empresa");
      if (!name) return;
      await updateDoc(doc(db, "companies", companyId), { name });
      $("#companyName").textContent = name;
    });

    function setupPerfilButton() {
      $("#btnPerfil").addEventListener("click", async () => {
        try {
          const userRef = doc(db, "users", currentUser.uid);
          const snapU = await getDoc(userRef);
          const currentUserPct = snapU.exists() ? (snapU.data().ahorroSugeridoPct || 0) : 0;

          const compRef = doc(db, "companies", companyId);
          const snapC = await getDoc(compRef);
          const currentDebtPct = snapC.exists() ? (snapC.data().mandatoryDebtPct || 0.10) : 0.10;

          const inputUser = prompt("Porcentaje sugerido de ahorro personal (0-100). Ej: 20", String(Math.round(currentUserPct*100)));
          if (inputUser !== null) {
            const val = Number(inputUser);
            if (!isNaN(val) && val >=0 && val <=100) {
              await updateDoc(userRef, { ahorroSugeridoPct: val/100 });
              alert("Ahorro personal guardado: " + val + "%");
            } else alert("Valor inv√°lido");
          }

          const inputDebt = prompt("Porcentaje obligatorio para deudas por ingreso (%). Ej: 10", String(Math.round(currentDebtPct*100)));
          if (inputDebt !== null) {
            const val2 = Number(inputDebt);
            if (!isNaN(val2) && val2 >=0 && val2 <=100) {
              await updateDoc(compRef, { mandatoryDebtPct: val2/100 });
              alert("Porcentaje de deudas guardado: " + val2 + "%");
            } else alert("Valor inv√°lido");
          }

        } catch (err) {
          console.error(err); alert("Error guardando perfil");
        }
      });
    }

    // periodic refresh for charts
    setInterval(() => { try { refreshCharts(); } catch(e){} }, 30_000);

    // initial: click first tab
    document.addEventListener("DOMContentLoaded", () => {
      const first = document.querySelector('.tab-btn');
      if (first) first.click();
    });

  </script>
</body>
</html>
