<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finanzas — Joyería</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Login -->
  <div id="loginSection" class="flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
      <input id="loginEmail" type="email" placeholder="Correo" class="w-full p-2 border rounded mb-4">
      <input id="loginPassword" type="password" placeholder="Contraseña" class="w-full p-2 border rounded mb-4">
      <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Ingresar</button>
      <p class="text-center mt-4">
        ¿No tienes cuenta? <a href="#" onclick="showRegister()" class="text-blue-600">Regístrate</a>
      </p>
    </div>
  </div>

  <!-- Registro -->
  <div id="registerSection" class="hidden flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2>
      <input id="registerName" type="text" placeholder="Tu nombre" class="w-full p-2 border rounded mb-4">
      <input id="registerEmail" type="email" placeholder="Correo" class="w-full p-2 border rounded mb-4">
      <input id="registerPassword" type="password" placeholder="Contraseña" class="w-full p-2 border rounded mb-4">
      <button onclick="register()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Registrar</button>
      <p class="text-center mt-4">
        ¿Ya tienes cuenta? <a href="#" onclick="showLogin()" class="text-blue-600">Inicia sesión</a>
      </p>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden p-6">
    <h1 class="text-3xl font-bold mb-6">Panel de Finanzas</h1>

    <!-- Saldos -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white shadow rounded p-4">
        <h2 class="font-bold">Caja Brandon</h2>
        <p id="saldoBrandon" class="text-xl">0</p>
      </div>
      <div class="bg-white shadow rounded p-4">
        <h2 class="font-bold">Caja Socia</h2>
        <p id="saldoSocia" class="text-xl">0</p>
      </div>
      <div class="bg-white shadow rounded p-4">
        <h2 class="font-bold">Caja Empresa</h2>
        <p id="saldoEmpresa" class="text-xl">0</p>
      </div>
    </div>

    <!-- Registro de Venta -->
    <div class="bg-white shadow rounded p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Registrar Venta</h2>
      <input id="ventaCosto" type="number" placeholder="Costo del producto" class="w-full p-2 border rounded mb-2">
      <input id="ventaPrecio" type="number" placeholder="Precio de venta" class="w-full p-2 border rounded mb-2">
      <select id="ventaOrigen" class="w-full p-2 border rounded mb-4">
        <option value="brandon">Brandon</option>
        <option value="socia">Socia</option>
        <option value="empresa">Empresa</option>
      </select>
      <button onclick="registrarVenta()" class="bg-blue-600 text-white px-4 py-2 rounded">Guardar Venta</button>
    </div>

    <!-- Registro de Gasto -->
    <div class="bg-white shadow rounded p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Registrar Gasto</h2>
      <input id="gastoMonto" type="number" placeholder="Monto del gasto" class="w-full p-2 border rounded mb-2">
      <select id="gastoOrigen" class="w-full p-2 border rounded mb-4">
        <option value="brandon">Brandon</option>
        <option value="socia">Socia</option>
        <option value="empresa">Empresa</option>
      </select>
      <button onclick="registrarGasto()" class="bg-red-600 text-white px-4 py-2 rounded">Guardar Gasto</button>
    </div>

    <!-- Registro de Meta -->
    <div class="bg-white shadow rounded p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Registrar Meta</h2>
      <input id="metaNombre" type="text" placeholder="Nombre de la meta" class="w-full p-2 border rounded mb-2">
      <input id="metaMonto" type="number" placeholder="Monto necesario" class="w-full p-2 border rounded mb-2">
      <select id="metaOrigen" class="w-full p-2 border rounded mb-4">
        <option value="brandon">Brandon</option>
        <option value="socia">Socia</option>
        <option value="empresa">Empresa</option>
      </select>
      <button onclick="registrarMeta()" class="bg-green-600 text-white px-4 py-2 rounded">Guardar Meta</button>
    </div>

    <!-- Estadísticas -->
    <div class="bg-white shadow rounded p-6 mb-6">
      <h2 class="text-2xl font-bold mb-4">Estadísticas</h2>
      <canvas id="graficoGanancias"></canvas>
    </div>
  </div>
<!-- PARTE 2: SCRIPT (pegar después de la Parte 1) -->
<script type="text/javascript">
  // ------------------------------
  // CONFIG FIREBASE (usa tu config)
  // ------------------------------
  // Si ya incluiste firebaseConfig en otro sitio, elimina el bloque aquí.
  const firebaseConfig = {
    apiKey: "AIzaSyCTFSlLoKv6KKujTqjMeMjNc-AlKQ2-rng",
    authDomain: "duostyle01-611b9.firebaseapp.com",
    projectId: "duostyle01-611b9",
    storageBucket: "duostyle01-611b9.firebasestorage.app",
    messagingSenderId: "4630065257",
    appId: "1:4630065257:web:11b7b0a0ac2fa776bbf2f8",
    measurementId: "G-FW6QEJMZKT"
  };

  // Inicializar Firebase (compat)
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- Helpers UI ----------
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmtMoney = n => `$${Number(n||0).toLocaleString('es-CO',{maximumFractionDigits:2})}`;

  // ---------- Estado local ----------
  let currentUser = null;
  let companyId = null;
  let unsubscribers = [];

  // ---------- UI show/hide ----------
  function showLogin(){ $("#loginSection").classList.remove("hidden"); $("#registerSection").classList.add("hidden"); $("#dashboard").classList.add("hidden"); }
  function showRegister(){ $("#loginSection").classList.add("hidden"); $("#registerSection").classList.remove("hidden"); $("#dashboard").classList.add("hidden"); }
  function showDashboard(){ $("#loginSection").classList.add("hidden"); $("#registerSection").classList.add("hidden"); $("#dashboard").classList.remove("hidden"); }

  // ---------- Auth actions ----------
  async function login(){
    try{
      const email = $("#loginEmail").value.trim();
      const pass  = $("#loginPassword").value.trim();
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(err){ alert("Error login: "+err.message); console.error(err); }
  }

  async function register(){
    try{
      const name = $("#registerName").value.trim();
      const email = $("#registerEmail").value.trim();
      const pass  = $("#registerPassword").value.trim();
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      // crear user doc
      await db.collection("users").doc(cred.user.uid).set({ displayName: name, email, ahorroSugeridoPct: 0 });
      // crear company por defecto
      const cid = `${cred.user.uid}-company`;
      await db.collection("companies").doc(cid).set({
        name: "Joyería — Empresa",
        owners: [{ uid: cred.user.uid, name }],
        mandatoryDebtPct: 0.10
      });
      await db.collection("companies").doc(cid).collection("state").doc("balances").set({
        cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
      });
      alert("Registrado. Inicia sesión.");
      showLogin();
    }catch(err){ alert("Error registro: "+err.message); console.error(err); }
  }

  // ---------- Auth listener ----------
  auth.onAuthStateChanged(async user => {
    // cleanup subs
    unsubscribers.forEach(u => u && u());
    unsubscribers = [];

    currentUser = user;
    if (!user) { showLogin(); return; }

    // determine company id (MVP: one company per user)
    companyId = `${user.uid}-company`;
    // ensure company exists
    const compRef = db.collection("companies").doc(companyId);
    const compSnap = await compRef.get();
    if (!compSnap.exists) {
      await compRef.set({
        name: "Joyería — Empresa",
        owners: [{ uid: user.uid, name: user.displayName || "Owner" }],
        mandatoryDebtPct: 0.10
      });
      await compRef.collection("state").doc("balances").set({
        cajaEmpresa: 0, cajaBrandon: 0, cajaSocia: 0, inversiones: 0, deudasTotales: 0
      });
    }

    // show dashboard and start listeners
    showDashboard();
    startListeners();
    await recomputeBalances(); // initial
  });

  // ---------- Start subscriptions ----------
  function startListeners(){
    // subscribe balances for UI KPIs
    const balRef = db.collection("companies").doc(companyId).collection("state").doc("balances");
    const unsubBal = balRef.onSnapshot(snap => {
      const d = snap.exists ? snap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0, deudasTotales:0 };
      $("#saldoBrandon").textContent = fmtMoney(d.cajaBrandon);
      $("#saldoSocia").textContent = fmtMoney(d.cajaSocia);
      $("#saldoEmpresa").textContent = fmtMoney(d.cajaEmpresa);
      // (deudas totales could be shown somewhere else)
    });
    unsubscribers.push(unsubBal);

    // subscribe collections to refresh tables and recompute
    const salesQ = db.collection("companies").doc(companyId).collection("sales").orderBy("createdAt","desc");
    const expQ   = db.collection("companies").doc(companyId).collection("expenses").orderBy("createdAt","desc");
    const movQ   = db.collection("companies").doc(companyId).collection("movements").orderBy("createdAt","desc");
    const debQ   = db.collection("companies").doc(companyId).collection("debts").orderBy("createdAt","desc");
    const goalsQ = db.collection("companies").doc(companyId).collection("goals").orderBy("createdAt","desc");

    unsubscribers.push(salesQ.onSnapshot(renderSales));
    unsubscribers.push(expQ.onSnapshot(renderExpenses));
    unsubscribers.push(movQ.onSnapshot(renderMovements));
    unsubscribers.push(debQ.onSnapshot(renderDebts));
    unsubscribers.push(goalsQ.onSnapshot(renderGoals));

    // when any of these change, recompute balances (we also call recompute in handlers)
    unsubscribers.push(salesQ.onSnapshot(() => recomputeBalances()));
    unsubscribers.push(expQ.onSnapshot(() => recomputeBalances()));
    unsubscribers.push(movQ.onSnapshot(() => recomputeBalances()));
    unsubscribers.push(debQ.onSnapshot(() => recomputeBalances()));
    unsubscribers.push(goalsQ.onSnapshot(() => recomputeBalances()));
  }

  // ---------- UI render helpers (tables) ----------
  async function renderSales(snapshot){
    const tbody = document.getElementById("tbVentas");
    if (!tbody) return;
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const s = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.date||''}</td>
        <td>${s.producto||''}</td>
        <td>${fmtMoney(s.precio||0)}</td>
        <td>${fmtMoney(s.costo||0)}</td>
        <td>${fmtMoney(s.utilidad||0)}</td>
        <td>
          <button onclick="editSale('${doc.id}')">Editar</button>
          <button onclick="deleteSale('${doc.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function renderExpenses(snapshot){
    const tbody = document.getElementById("tbGastos");
    if (!tbody) return;
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const g = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.date||''}</td>
        <td>${g.categoria||''}</td>
        <td>${fmtMoney(g.monto||0)}</td>
        <td>${g.pagadoPor||''}</td>
        <td>
          <button onclick="editExpense('${doc.id}')">Editar</button>
          <button onclick="deleteExpense('${doc.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function renderMovements(snapshot){
    const tbody = document.getElementById("tbMovimientos");
    if (!tbody) return;
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const m = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.fecha||''}</td>
        <td>${m.tipo||''}</td>
        <td>${m.cuenta||''}</td>
        <td>${fmtMoney(m.monto||0)}</td>
        <td>${m.desc||''}</td>
        <td>
          <button onclick="editMov('${doc.id}')">Editar</button>
          <button onclick="deleteMov('${doc.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function renderDebts(snapshot){
    const tbody = document.getElementById("tbDeudas");
    if (!tbody) return;
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.acreedor||''}</td>
        <td>${d.tipo||''}</td>
        <td>${fmtMoney(d.saldo||0)}</td>
        <td>
          <button onclick="editDebt('${doc.id}')">Editar</button>
          <button onclick="deleteDebt('${doc.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function renderGoals(snapshot){
    const tbody = document.getElementById("tbMetas");
    if (!tbody) return;
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
      const g = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${g.nombre||''}</td>
        <td>${g.tipo||''}</td>
        <td>${fmtMoney(g.objetivoMonto||0)}</td>
        <td>${fmtMoney(g.acumulado||0)}</td>
        <td>
          <button onclick="editGoal('${doc.id}')">Editar</button>
          <button onclick="deleteGoal('${doc.id}')">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ---------- computePaidBy (uniform rule) ----------
  // financiadoPor: 'empresa'|'brandon'|'socia'
  // amount: monto a cubrir (costo o gasto)
  // createMovements: si true crea movimientos 'egreso' para los adelantos de socios (cuando empresa insuficiente)
  async function computePaidBy(financiadoPor, amount, createMovements = false) {
    try {
      const balSnap = await db.collection("companies").doc(companyId).collection("state").doc("balances").get();
      const balances = balSnap.exists ? balSnap.data() : { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0 };
      const empresaCaja = Number(balances.cajaEmpresa || 0);

      let paid = { empresa:0, brandon:0, socia:0 };

      if (financiadoPor === "brandon") {
        paid.brandon = amount;
      } else if (financiadoPor === "socia") {
        paid.socia = amount;
      } else { // empresa
        if (empresaCaja >= amount) {
          paid.empresa = amount;
        } else {
          // empresa insuff -> empresa covers what it has (maybe 0), remainder split 50/50
          paid.empresa = Math.max(0, empresaCaja);
          const shortage = amount - paid.empresa;
          const half = Number((shortage/2).toFixed(2));
          paid.brandon = half;
          paid.socia = half;
          const remainder = Number((shortage - (half*2)).toFixed(2));
          if (remainder !== 0) paid.brandon = Number((paid.brandon + remainder).toFixed(2));
        }
      }

      // create movements for partner advances (egreso) if requested and there is an advance
      if (createMovements) {
        const ops = [];
        if (paid.brandon && paid.brandon > 0) {
          ops.push(db.collection("companies").doc(companyId).collection("movements").add({
            tipo: "egreso",
            cuenta: "cajaBrandon",
            fecha: new Date().toISOString().slice(0,10),
            monto: paid.brandon,
            desc: `Anticipo Brandon (${financiadoPor})`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }));
        }
        if (paid.socia && paid.socia > 0) {
          ops.push(db.collection("companies").doc(companyId).collection("movements").add({
            tipo: "egreso",
            cuenta: "cajaSocia",
            fecha: new Date().toISOString().slice(0,10),
            monto: paid.socia,
            desc: `Anticipo Socia (${financiadoPor})`,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }));
        }
        if (ops.length) await Promise.all(ops);
      }

      return paid;
    } catch (err) {
      console.error("computePaidBy error", err);
      const half = Number((amount/2).toFixed(2));
      return { empresa:0, brandon:half, socia:half };
    }
  }

  // ---------- recomputeBalances (from scratch) ----------
  // Order of processing:
  //  1) movements (apply directly)
  //  2) sales (price enters empresa, then cost is removed from empresa; partners reimbursed according to sold.asignaciones.paidBy)
  //  3) expenses (use paidDistribution if present; otherwise pagadoPor)
  //  4) debts (sum saldos)
  //  5) goals (acumulados reduce the corresponding cash)
  async function recomputeBalances(){
    try {
      const base = { cajaEmpresa:0, cajaBrandon:0, cajaSocia:0, inversiones:0, deudasTotales:0 };

      // MOVEMENTS
      const movSnap = await db.collection("companies").doc(companyId).collection("movements").get();
      movSnap.forEach(d => {
        const m = d.data();
        const monto = Number(m.monto || 0);
        const sign = (m.tipo === "ingreso") ? 1 : -1;
        const delta = sign * monto;
        if (m.cuenta === "cajaEmpresa") base.cajaEmpresa += delta;
        if (m.cuenta === "cajaBrandon") base.cajaBrandon += delta;
        if (m.cuenta === "cajaSocia") base.cajaSocia += delta;
        if (m.cuenta === "inversiones") base.inversiones += delta;
        if (m.cuenta === "deudasTotales") base.deudasTotales += delta;
      });

      // SALES
      const salesSnap = await db.collection("companies").doc(companyId).collection("sales").get();
      salesSnap.forEach(d => {
        const s = d.data();
        const price = Number(s.precio || 0);
        const cost  = Number(s.costo || 0);
        const utilidad = Number(s.utilidad || (price - cost) || 0);
        const a = s.asignaciones || {};

        // price enters empresa
        base.cajaEmpresa += price;

        // cost: company gives the cost to reimburse capital (but if paidBy had partner portions, partners already lost money via movements)
        // Approach: we subtract the COST from empresa, then credit partners according to a.paidBy (so net empresa reduction equals a.paidBy.empresa)
        base.cajaEmpresa -= cost;

        if (a.paidBy) {
          base.cajaBrandon += Number(a.paidBy.brandon || 0);
          base.cajaSocia += Number(a.paidBy.socia || 0);
          // a.paidBy.empresa is implicit (empresa effective out = cost - (brandon+socia))
        } else {
          // fallback: use financiadoPor if paidBy missing
          const financedBy = a.financiadoPor || "empresa";
          if (financedBy === "brandon") base.cajaBrandon += cost;
          if (financedBy === "socia") base.cajaSocia += cost;
          // if empresa: nothing extra (empresa already paid cost)
        }

        // reparto utilidad (50/50)
        if (utilidad > 0) {
          base.cajaEmpresa -= utilidad;
          base.cajaBrandon += utilidad / 2;
          base.cajaSocia += utilidad / 2;
        }

        // reinversion / pagoDeuda optional fields
        if (a.reinversion) {
          base.cajaEmpresa -= Number(a.reinversion || 0);
          base.inversiones += Number(a.reinversion || 0);
        }
        if (a.pagoDeuda) {
          base.cajaEmpresa -= Number(a.pagoDeuda || 0);
          base.deudasTotales -= Number(a.pagoDeuda || 0);
        }
      });

      // EXPENSES
      const expSnap = await db.collection("companies").doc(companyId).collection("expenses").get();
      expSnap.forEach(d => {
        const g = d.data();
        const monto = Number(g.monto || 0);
        if (g.paidDistribution) {
          // Use the stored distribution to avoid double counting and to honor partner advances
          base.cajaEmpresa -= Number(g.paidDistribution.empresa || 0);
          base.cajaBrandon -= Number(g.paidDistribution.brandon || 0);
          base.cajaSocia   -= Number(g.paidDistribution.socia || 0);
        } else {
          // fallback: depending who paid
          if (g.pagadoPor === "empresa") base.cajaEmpresa -= monto;
          if (g.pagadoPor === "brandon") base.cajaBrandon -= monto;
          if (g.pagadoPor === "socia")   base.cajaSocia   -= monto;
        }
      });

      // DEBTS
      const debtsSnap = await db.collection("companies").doc(companyId).collection("debts").get();
      debtsSnap.forEach(d => {
        const dd = d.data();
        const saldo = Number(dd.saldo || dd.montoInicial || 0);
        base.deudasTotales += saldo;
      });

      // GOALS
      const goalsSnap = await db.collection("companies").doc(companyId).collection("goals").get();
      goalsSnap.forEach(d => {
        const g = d.data();
        const acum = Number(g.acumulado || 0);
        if (g.tipo === "negocio") base.cajaEmpresa -= acum;
        if (g.tipo === "brandon") base.cajaBrandon -= acum;
        if (g.tipo === "socia")   base.cajaSocia   -= acum;
      });

      // ensure no -0 and round
      for (const k in base) base[k] = Number(base[k].toFixed(2));

      // IMPORTANT: we do NOT force balances to be >=0 here; we rely on computePaidBy & movements to avoid negative company balance.
      // But to be safe with display we will write the computed values as is:
      await db.collection("companies").doc(companyId).collection("state").doc("balances").set(base, { merge: true });

    } catch (err) {
      console.error("recomputeBalances error:", err);
    }
  }

  // ---------- Registrar Venta ----------
  async function registrarVenta(){
    try{
      const costo = Number(document.getElementById("ventaCosto").value || 0);
      const precio = Number(document.getElementById("ventaPrecio").value || 0);
      const origen = document.getElementById("ventaOrigen").value; // empresa/brandon/socia

      if (precio <= 0) return alert("Precio debe ser > 0");
      if (costo < 0) return alert("Costo inválido");

      const utilidad = precio - costo;
      // Decide paidBy and create partner advance movements if company insufficient
      const paidBy = await computePaidBy(origen, costo, true); // true -> create movements if partners advance

      // store sale with asignaciones.paidBy so recompute can use it
      await db.collection("companies").doc(companyId).collection("sales").add({
        date: new Date().toISOString().slice(0,10),
        producto: "Venta (manual)",
        costo,
        precio,
        utilidad,
        margen: precio ? utilidad / precio : 0,
        asignaciones: { financiadoPor: origen, paidBy, manualMode:false },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // recompute balances robustamente
      await recomputeBalances();

      // reset UI
      document.getElementById("ventaCosto").value = "";
      document.getElementById("ventaPrecio").value = "";
      alert("Venta registrada");
    }catch(err){ console.error(err); alert("Error registrarVenta: " + err.message); }
  }

  // ---------- Registrar Gasto ----------
  async function registrarGasto(){
    try{
      const monto = Number(document.getElementById("gastoMonto").value || 0);
      const origen = document.getElementById("gastoOrigen").value;

      if (monto <= 0) return alert("Monto debe ser > 0");

      // compute distribution and create partner advance movements if needed
      const paidDistribution = await computePaidBy(origen, monto, true);

      // save expense with paidDistribution
      await db.collection("companies").doc(companyId).collection("expenses").add({
        date: new Date().toISOString().slice(0,10),
        categoria: "Gasto (manual)",
        monto,
        descripcion: "",
        pagadoPor: origen,
        paidDistribution,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await recomputeBalances();
      document.getElementById("gastoMonto").value = "";
      alert("Gasto registrado");
    }catch(err){ console.error(err); alert("Error registrarGasto: " + err.message); }
  }

  // ---------- Registrar Meta ----------
  async function registrarMeta(){
    try{
      const nombre = document.getElementById("metaNombre").value.trim();
      const monto = Number(document.getElementById("metaMonto").value || 0);
      const origen = document.getElementById("metaOrigen").value;

      if (!nombre) return alert("Nombre requerido");
      if (monto <= 0) return alert("Monto mayor a 0");

      await db.collection("companies").doc(companyId).collection("goals").add({
        tipo: origen,
        nombre,
        objetivoMonto: monto,
        acumulado: 0,
        notas: "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await recomputeBalances();
      document.getElementById("metaNombre").value = "";
      document.getElementById("metaMonto").value = "";
      alert("Meta creada");
    } catch(err){ console.error(err); alert("Error registrarMeta: "+err.message); }
  }

  // ---------- Simple CRUD helpers (delete/edit) ----------
  async function deleteSale(id){ if (!confirm("Eliminar venta?")) return; await db.collection("companies").doc(companyId).collection("sales").doc(id).delete(); await recomputeBalances(); }
  async function deleteExpense(id){ if (!confirm("Eliminar gasto?")) return; await db.collection("companies").doc(companyId).collection("expenses").doc(id).delete(); await recomputeBalances(); }
  async function deleteMov(id){ if (!confirm("Eliminar movimiento?")) return; await db.collection("companies").doc(companyId).collection("movements").doc(id).delete(); await recomputeBalances(); }
  async function deleteDebt(id){ if (!confirm("Eliminar deuda?")) return; await db.collection("companies").doc(companyId).collection("debts").doc(id).delete(); await recomputeBalances(); }
  async function deleteGoal(id){ if (!confirm("Eliminar meta?")) return; await db.collection("companies").doc(companyId).collection("goals").doc(id).delete(); await recomputeBalances(); }

  // (edit handlers: simple approach: prefill inputs and delete doc, user re-create corrected entry)
  async function editSale(id){
    const docSnap = await db.collection("companies").doc(companyId).collection("sales").doc(id).get();
    if (!docSnap.exists) return alert("No encontrado");
    const d = docSnap.data();
    // prefill (simple)
    document.getElementById("ventaCosto").value = d.costo || "";
    document.getElementById("ventaPrecio").value = d.precio || "";
    document.getElementById("ventaOrigen").value = (d.asignaciones && d.asignaciones.financiadoPor) || "empresa";
    // delete old doc (we recompute after)
    await db.collection("companies").doc(companyId).collection("sales").doc(id).delete();
    await recomputeBalances();
    // user can adjust and save again
  }
  async function editExpense(id){
    const docSnap = await db.collection("companies").doc(companyId).collection("expenses").doc(id).get();
    if (!docSnap.exists) return alert("No encontrado");
    const d = docSnap.data();
    document.getElementById("gastoMonto").value = d.monto || "";
    document.getElementById("gastoOrigen").value = d.pagadoPor || "empresa";
    await db.collection("companies").doc(companyId).collection("expenses").doc(id).delete();
    await recomputeBalances();
  }
  async function editMov(id){
    const docSnap = await db.collection("companies").doc(companyId).collection("movements").doc(id).get();
    if (!docSnap.exists) return alert("No encontrado");
    const d = docSnap.data();
    // prefill form (if present)
    alert("Edite manualmente el movimiento: primero copie los valores del movimiento en el formulario de Movimientos.");
    // delete for now
    await db.collection("companies").doc(companyId).collection("movements").doc(id).delete();
    await recomputeBalances();
  }
  async function editDebt(id){ const s = await db.collection("companies").doc(companyId).collection("debts").doc(id).get(); if (!s.exists) return alert("No encontrado"); const d = s.data(); alert("Edite: prefill manualmente luego elimine o actualice."); await db.collection("companies").doc(companyId).collection("debts").doc(id).delete(); await recomputeBalances(); }
  async function editGoal(id){ const s = await db.collection("companies").doc(companyId).collection("goals").doc(id).get(); if (!s.exists) return alert("No encontrado"); const d = s.data(); document.getElementById("metaNombre").value = d.nombre || ""; document.getElementById("metaMonto").value = d.objetivoMonto || ""; await db.collection("companies").doc(companyId).collection("goals").doc(id).delete(); await recomputeBalances(); }

  // ---------- Simple movements form (optional) ----------
  // You can add UI for movements similar to others if desired; for now we allow direct deletion/creation via computePaidBy

  // ---------- Charts (simple) ----------
  // Minimal chart to show net profit history; you can enhance later
  let chart = null;
  async function drawChart(){
    try{
      const sales = await db.collection("companies").doc(companyId).collection("sales").orderBy("createdAt","asc").get();
      const labels = [], data = [];
      sales.forEach(s => { const d = s.data(); labels.push(d.date || ""); data.push(Number(d.utilidad||0)); });
      const ctx = document.getElementById("graficoGanancias").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Utilidad por venta', data, backgroundColor: '#34d399' }] },
        options: { responsive:true, maintainAspectRatio:false }
      });
    }catch(err){ console.error("drawChart", err); }
  }

  // call drawChart periodically (or on sales changes)
  setInterval(() => { if (companyId) drawChart(); }, 5000);

  // ---------- Logout UI ----------
  // For convenience add logout on top-right or similar; here we add global key
  document.addEventListener("keydown", (e) => {
    // Ctrl+L to logout (quick)
    if (e.ctrlKey && e.key === 'l') {
      if (confirm("Cerrar sesión?")) auth.signOut();
    }
  });

  // ---------- Initial UI state ----------
  showLogin();

  // Expose functions to global so buttons in HTML can call them
  window.login = login;
  window.register = register;
  window.showLogin = showLogin;
  window.showRegister = showRegister;
  window.registrarVenta = registrarVenta;
  window.registrarGasto = registrarGasto;
  window.registrarMeta = registrarMeta;
  window.deleteSale = deleteSale;
  window.deleteExpense = deleteExpense;
  window.deleteMov = deleteMov;
  window.deleteDebt = deleteDebt;
  window.deleteGoal = deleteGoal;
  window.editSale = editSale;
  window.editExpense = editExpense;
  window.editMov = editMov;
  window.editDebt = editDebt;
  window.editGoal = editGoal;
</script>
<!-- FIN PARTE 2 -->
